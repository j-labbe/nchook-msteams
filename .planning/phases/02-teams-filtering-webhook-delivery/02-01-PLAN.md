---
phase: 02-teams-filtering-webhook-delivery
plan: 01
type: execute
wave: 1
depends_on: []
files_modified: [nchook.py, config.json]
autonomous: true

must_haves:
  truths:
    - "Config file is loaded at startup with defaults merged and webhook_url validated"
    - "Only Teams notifications (matching configured bundle IDs) pass the filter"
    - "Notifications missing sender or body are rejected"
    - "Notifications where title is Microsoft Teams are rejected"
    - "Known noise patterns (reactions, calls, join/leave) are rejected"
    - "Notifications are classified as direct_message, channel_message, or mention"
    - "Long messages (>=150 chars without sentence-ending punctuation) are flagged as truncated"
  artifacts:
    - path: "nchook.py"
      provides: "Config loading and filtering functions"
      contains: "def load_config"
    - path: "nchook.py"
      provides: "Three-stage filter pipeline"
      contains: "def passes_filter"
    - path: "nchook.py"
      provides: "Notification type classification"
      contains: "def classify_notification"
    - path: "nchook.py"
      provides: "Truncation detection"
      contains: "def detect_truncation"
    - path: "config.json"
      provides: "Example config file with webhook_url, bundle_ids, poll_interval, log_level"
      contains: "webhook_url"
  key_links:
    - from: "load_config()"
      to: "config.json"
      via: "json.load on file resolved relative to script directory"
      pattern: "json\\.load"
    - from: "passes_filter()"
      to: "config[bundle_ids]"
      via: "set membership check for bundle ID filtering"
      pattern: "bundle_ids"
---

<objective>
Add config file loading, Teams notification filtering (bundle ID, allowlist, system alert rejection, noise pattern rejection), notification type classification, and truncation detection as standalone functions in nchook.py. Create the example config.json file.

Purpose: These pure functions form the filtering pipeline that Phase 2 Plan 02 will wire into the event loop. By implementing them as standalone functions first, they can be verified independently before integration.
Output: nchook.py with 10+ new functions (load_config, passes_filter, passes_bundle_id_filter, passes_allowlist_filter, is_system_alert, is_noise_notification, classify_notification, detect_truncation, plus constants). config.json example file.
</objective>

<execution_context>
@~/.claude/get-shit-done/workflows/execute-plan.md
@~/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/02-teams-filtering-webhook-delivery/02-RESEARCH.md
@.planning/phases/01-db-watcher-state-engine/01-01-SUMMARY.md
@.planning/phases/01-db-watcher-state-engine/01-02-SUMMARY.md
@nchook.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add config loading and Teams filtering functions to nchook.py</name>
  <files>nchook.py, config.json</files>
  <action>
Add the following to nchook.py, placing new sections AFTER the existing "Startup Summary" section and BEFORE the "kqueue WAL Watcher" section. Keep all existing Phase 1 code untouched.

**New imports** (add to existing import block at top):
- `import urllib.request` (needed for Plan 02, but add now to avoid Plan 02 touching the import block)
- `import urllib.error` (same reason)
- `import re` (for future noise pattern refinement, though v1 uses string matching)

**New constants** (new section: "Configuration"):
- `CONFIG_FILE = "config.json"` -- resolved relative to script dir at load time
- `DEFAULT_CONFIG` dict with keys: `bundle_ids` (list: `["com.microsoft.teams2", "com.microsoft.teams"]`), `poll_interval` (5.0), `log_level` ("INFO"), `webhook_timeout` (10)

**New function: `load_config(config_path=None)`** (CONF-01):
- If config_path is None, resolve CONFIG_FILE relative to the script's directory using `os.path.dirname(os.path.abspath(__file__))` -- this ensures the daemon finds config.json regardless of CWD (per research recommendation).
- Start with a copy of DEFAULT_CONFIG.
- Read and parse the JSON file. On FileNotFoundError, log clear error ("Config file not found: {path}") and sys.exit(1). On JSONDecodeError, log the parse error and sys.exit(1).
- Merge user config over defaults with dict.update().
- Validate: if "webhook_url" not in config or empty, log error ("Config missing required field: webhook_url") and sys.exit(1).
- Convert bundle_ids list to a set for O(1) lookup.
- Return the merged config dict.

**New constants** (new section: "Teams Filtering"):
- `NOISE_PATTERNS` list of strings for known English-locale Teams noise (per research): "Liked", "Loved", "Laughed at", "Was surprised by", "Was sad at", "is calling you", "Missed call from", "Incoming call", "joined the meeting", "left the meeting", "Meeting started", "is presenting", "has been added", "has left", "has joined", "is typing"
- `SENTENCE_ENDINGS` frozenset: `.!?"')`

**New function: `passes_bundle_id_filter(notif, bundle_ids)`** (FILT-01):
- Return `notif["app"] in bundle_ids`

**New function: `passes_allowlist_filter(notif)`** (FILT-02):
- Return True only if both `notif.get("title", "").strip()` and `notif.get("body", "").strip()` are non-empty.

**New function: `is_system_alert(notif)`** (FILT-03):
- Return True if `notif.get("title", "").strip() == "Microsoft Teams"`

**New function: `is_noise_notification(body, title)`** (FILT-04):
- Strip body. For each pattern in NOISE_PATTERNS, check if body starts with pattern or equals pattern exactly.
- Return True if any match, False otherwise.

**New function: `passes_filter(notif, config)`** (FILT-01..04 combined):
- Stage 1: `passes_bundle_id_filter(notif, config["bundle_ids"])` -- return False if fails
- Stage 2: `passes_allowlist_filter(notif)` -- return False if fails
- Stage 3: `is_system_alert(notif)` -- return False if True
- Stage 4: `is_noise_notification(notif.get("body", ""), notif.get("title", ""))` -- return False if True
- Return True if all stages pass

**New function: `classify_notification(notif)`** (FILT-05):
- Check body for "@" -> return "mention"
- Check subtitle for "|" or ">" separators -> return "channel_message"
- If subtitle present and differs from title -> return "channel_message"
- Default: return "direct_message"

**New function: `detect_truncation(body)`** (WEBH-04):
- If `len(body) < 150`, return False
- If body ends with char in SENTENCE_ENDINGS, return False
- Return True

**Create config.json** in project root with example values:
```json
{
    "webhook_url": "https://example.com/webhook",
    "bundle_ids": ["com.microsoft.teams2", "com.microsoft.teams"],
    "poll_interval": 5.0,
    "log_level": "INFO",
    "webhook_timeout": 10
}
```

IMPORTANT: Do NOT modify any existing Phase 1 functions. Only ADD new sections and functions.
  </action>
  <verify>
Run Python to verify all new functions are importable and behave correctly:

```bash
python3 -c "
from nchook import (load_config, passes_filter, passes_bundle_id_filter,
                     passes_allowlist_filter, is_system_alert,
                     is_noise_notification, classify_notification,
                     detect_truncation, NOISE_PATTERNS, SENTENCE_ENDINGS,
                     DEFAULT_CONFIG)

# Config loading -- verify defaults exist
assert 'bundle_ids' in DEFAULT_CONFIG
assert 'poll_interval' in DEFAULT_CONFIG

# Bundle ID filter
assert passes_bundle_id_filter({'app': 'com.microsoft.teams2'}, {'com.microsoft.teams2'})
assert not passes_bundle_id_filter({'app': 'com.apple.mail'}, {'com.microsoft.teams2'})

# Allowlist filter
assert passes_allowlist_filter({'title': 'John', 'body': 'Hello'})
assert not passes_allowlist_filter({'title': 'John', 'body': ''})
assert not passes_allowlist_filter({'title': '', 'body': 'Hello'})

# System alert
assert is_system_alert({'title': 'Microsoft Teams'})
assert not is_system_alert({'title': 'John Smith'})

# Noise patterns
assert is_noise_notification('Liked', 'John')
assert is_noise_notification('is calling you', 'John')
assert not is_noise_notification('Hey can you review this?', 'John')

# Full filter chain
config = {'bundle_ids': {'com.microsoft.teams2'}}
good = {'app': 'com.microsoft.teams2', 'title': 'John', 'body': 'Hello', 'subtitle': ''}
assert passes_filter(good, config)
noise = {'app': 'com.microsoft.teams2', 'title': 'John', 'body': 'Liked', 'subtitle': ''}
assert not passes_filter(noise, config)
wrong_app = {'app': 'com.apple.mail', 'title': 'John', 'body': 'Hello', 'subtitle': ''}
assert not passes_filter(wrong_app, config)
system = {'app': 'com.microsoft.teams2', 'title': 'Microsoft Teams', 'body': 'Activity', 'subtitle': ''}
assert not passes_filter(system, config)

# Classification
assert classify_notification({'body': '@You check this', 'subtitle': 'General', 'title': 'John'}) == 'mention'
assert classify_notification({'body': 'Hello', 'subtitle': 'Team | General', 'title': 'John'}) == 'channel_message'
assert classify_notification({'body': 'Hello', 'subtitle': 'General', 'title': 'John'}) == 'channel_message'
assert classify_notification({'body': 'Hello', 'subtitle': '', 'title': 'John'}) == 'direct_message'

# Truncation
assert not detect_truncation('Short message')
assert not detect_truncation('x' * 200 + '.')
assert detect_truncation('x' * 200)

print('All filter and config tests passed.')
"
```

Also verify config.json is valid JSON:
```bash
python3 -c "import json; json.load(open('config.json')); print('config.json is valid JSON')"
```
  </verify>
  <done>
All new functions are importable from nchook.py and pass the verification tests. config.json exists with valid JSON and all required fields. No existing Phase 1 functions are modified.

Requirements covered: CONF-01 (config loading), FILT-01 (bundle ID filter), FILT-02 (allowlist), FILT-03 (system alert rejection), FILT-04 (noise rejection), FILT-05 (classification), WEBH-04 (truncation detection).
  </done>
</task>

</tasks>

<verification>
- All 8 new functions importable from nchook.py
- Config loading validates webhook_url presence
- Filter chain correctly rejects non-Teams, empty body/title, system alerts, and noise
- Classification returns one of three valid types
- Truncation detection uses 150-char threshold with sentence-ending check
- config.json is valid JSON with all expected fields
- Existing Phase 1 functions remain unchanged (detect_db_path, validate_environment, parse_notification, query_new_notifications, save_state, load_state, check_db_consistency, print_startup_summary, create_wal_watcher, run_watcher, main)
</verification>

<success_criteria>
1. `python3 -c "from nchook import load_config, passes_filter, classify_notification, detect_truncation"` succeeds
2. All inline verification assertions pass
3. config.json exists and is valid JSON
4. `python3 nchook.py` still starts correctly (existing functionality preserved)
</success_criteria>

<output>
After completion, create `.planning/phases/02-teams-filtering-webhook-delivery/02-01-SUMMARY.md`
</output>
